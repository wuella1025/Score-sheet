<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸æœŸæˆç¸¾è¨ˆç®— (OCR ä¿®å¾©ç‰ˆ)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg-body: #2d3e46;
            --bg-card: #3b4c54;
            --text-main: #e0e6ed;
            --text-muted: #aab2bd;
            --accent-cyan: #4ecdc4;
            --accent-gold: #ffd700;
            --accent-red: #ff6b6b;
            --border: #4a5d66;
            --input-bg: #455a64;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 150px;
        }

        .container { max-width: 800px; margin: 0 auto; }
        h2 { text-align: center; color: var(--text-main); margin-bottom: 15px; }

        /* OCR æ§åˆ¶å€ */
        .controls {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .btn-ocr {
            background: var(--accent-cyan);
            color: #2d3e46;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
            display: inline-flex; align-items: center; gap: 8px;
        }

        /* ç‹€æ…‹èˆ‡é™¤éŒ¯é¡¯ç¤º */
        .ocr-status { margin-top: 10px; font-size: 0.9rem; color: var(--accent-cyan); min-height: 20px; }
        .progress-bar { width: 100%; height: 6px; background: #333; margin-top: 10px; border-radius: 3px; overflow: hidden; display: none; }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-cyan); transition: width 0.3s; }
        
        #debugText {
            display: none;
            width: 100%;
            height: 100px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #444;
            overflow-y: scroll;
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-header {
            display: grid;
            grid-template-columns: 30px 1fr 50px 50px 60px 30px;
            padding: 10px;
            font-weight: bold;
            color: var(--accent-gold);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
            text-align: center;
        }
        .list-header div:nth-child(2) { text-align: left; }

        .course-item {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin-bottom: 2px;
            border-radius: 4px;
        }
        .course-summary {
            display: grid;
            grid-template-columns: 30px 1fr 50px 50px 60px 30px;
            padding: 12px 10px;
            align-items: center;
        }

        input, select {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            font-size: 1rem;
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            outline: none;
            text-align: center;
        }
        .input-name { text-align: left; font-weight: bold; }
        input:focus { background: var(--input-bg); border-bottom: 2px solid var(--accent-cyan); }
        .score-display { font-weight: bold; font-size: 1.1rem; text-align: center; }

        /* RWD */
        @media (max-width: 600px) {
            .list-header { display: none; }
            .course-summary {
                grid-template-columns: 25px 1fr auto;
                grid-template-areas: "idx name score" "idx info score";
                gap: 5px;
            }
            .input-name { grid-area: name; font-size: 1.1rem; }
            .mobile-info { grid-area: info; display: flex; gap: 10px; font-size: 0.85rem; color: var(--text-muted); }
            .score-display { grid-area: score; text-align: right; min-width: 40px; }
            .desktop-only { display: none; }
        }

        .footer-stats {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #263238;
            border-top: 3px solid var(--accent-cyan);
            display: grid; grid-template-columns: repeat(4, 1fr);
            padding: 15px 5px; z-index: 100;
        }
        .stat-box { text-align: center; border-right: 1px solid var(--border); }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>å­¸æœŸæˆç¸¾è¨ˆç®— (OCR å¼·åŠ›ç‰ˆ)</h2>

    <div class="controls">
        <button class="btn-ocr" onclick="document.getElementById('fileInput').click()">
            ğŸ“· ä¸Šå‚³æˆªåœ– (è‡ªå‹•å¢å¼·å°æ¯”)
        </button>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImage(this)">
        
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="ocr-status" id="ocrStatus">è«‹ä¸Šå‚³æˆç¸¾å–®æˆªåœ–ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†é»‘åº•åœ–ç‰‡</div>
        <textarea id="debugText" readonly placeholder="é€™è£¡æœƒé¡¯ç¤º AI çœ‹åˆ°çš„åŸå§‹æ–‡å­—ï¼Œå¦‚æœè¾¨è­˜å¤±æ•—è«‹æŸ¥çœ‹é€™è£¡..."></textarea>
    </div>

    <div class="list-header">
        <div>#</div><div>èª²ç¨‹åç¨±</div><div>ä¿®åˆ¥</div><div>å­¸åˆ†</div><div>ç¸½åˆ†</div><div></div>
    </div>
    <div id="courseList"></div>
    <div id="emptyMsg" style="text-align:center; padding:30px; color:#888;">ç›®å‰ç„¡è³‡æ–™</div>
</div>

<div class="footer-stats">
    <div class="stat-box"><div class="stat-label">ç¸½å­¸åˆ†</div><div class="stat-val" id="totalCredits">0</div></div>
    <div class="stat-box"><div class="stat-label">å¯¦å¾—</div><div class="stat-val" id="earnedCredits">0</div></div>
    <div class="stat-box"><div class="stat-label">ä¸åŠæ ¼</div><div class="stat-val" id="failedCredits" style="color:#ff6b6b">0</div></div>
    <div class="stat-box"><div class="stat-label">å¹³å‡</div><div class="stat-val" id="semesterAvg" style="color:#ffd700">0.0</div></div>
</div>

<script>
    let courses = [];

    // --- åœ–åƒè™•ç†æ ¸å¿ƒ ---
    async function handleImage(input) {
        if (!input.files[0]) return;
        const status = document.getElementById('ocrStatus');
        const bar = document.getElementById('progressBar');
        const fill = document.getElementById('progressFill');
        const debugArea = document.getElementById('debugText');
        
        bar.style.display = 'block';
        debugArea.style.display = 'none';
        status.innerText = "æ­£åœ¨è™•ç†åœ–ç‰‡ (åè½‰é¡è‰²)...";

        try {
            // 1. é è™•ç†åœ–ç‰‡ï¼šåè½‰é¡è‰² (è§£æ±ºæ·±è‰²æ¨¡å¼å•é¡Œ)
            const processedImage = await preprocessImage(input.files[0]);

            // 2. å•Ÿå‹• Tesseract
            status.innerText = "å•Ÿå‹•è­˜åˆ¥å¼•æ“...";
            const worker = Tesseract.createWorker({
                logger: m => {
                    if(m.status === 'recognizing text') {
                        fill.style.width = `${m.progress * 100}%`;
                        status.innerText = `AI è®€å–ä¸­... ${Math.round(m.progress * 100)}%`;
                    }
                }
            });
            
            await worker.load();
            await worker.loadLanguage('chi_tra');
            await worker.initialize('chi_tra');

            // 3. è­˜åˆ¥
            const { data: { text } } = await worker.recognize(processedImage);
            await worker.terminate();

            // 4. é¡¯ç¤ºåŸå§‹æ–‡å­—ä¾›é™¤éŒ¯
            console.log("Raw OCR Text:", text);
            debugArea.value = "--- åŸå§‹è­˜åˆ¥çµæœ (ä¾›åƒè€ƒ) ---\n" + text;
            debugArea.style.display = 'block';

            // 5. è§£æ
            const newCourses = parseLooseText(text);

            if (newCourses.length > 0) {
                courses = [...courses, ...newCourses];
                render();
                status.innerText = `æˆåŠŸï¼æŠ“å–åˆ° ${newCourses.length} ç­†è³‡æ–™ã€‚`;
            } else {
                status.innerText = "âŒ è­˜åˆ¥å¤±æ•—ã€‚è«‹æŸ¥çœ‹ä¸‹æ–¹é»‘è‰²å€å¡Šçš„åŸå§‹æ–‡å­—ï¼Œè‹¥å…¨æ˜¯äº‚ç¢¼ä»£è¡¨åœ–ç‰‡å¤ªæ¨¡ç³Šã€‚";
            }

        } catch (e) {
            status.innerText = "éŒ¯èª¤ï¼š" + e.message;
            console.error(e);
        } finally {
            bar.style.display = 'none';
            input.value = ''; // é‡ç½®
        }
    }

    // åœ–ç‰‡é è™•ç†ï¼šå°‡åœ–ç‰‡ç•«åˆ° Canvas ä¸Šä¸¦åè½‰é¡è‰²
    function preprocessImage(file) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                // å–å¾—åƒç´ è³‡æ–™
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // ç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºæ·±è‰²æ¨¡å¼ (å–æ¨£ä¸­é–“ä¸€é»)
                // å¦‚æœ R,G,B éƒ½å¾ˆå° (<100)ï¼Œå‡è¨­æ˜¯æ·±è‰²èƒŒæ™¯ï¼ŒåŸ·è¡Œåè‰²
                // é€™è£¡æˆ‘å€‘ç›´æ¥å¼·åˆ¶åè‰²æ¸¬è©¦ï¼Œæˆ–è€…åšæ™ºæ…§åˆ¤æ–·ã€‚
                // ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘æª¢æŸ¥æ•´å¼µåœ–çš„å¹³å‡äº®åº¦
                let totalBrightness = 0;
                for(let i=0; i<data.length; i+=40) { // å–æ¨£åŠ é€Ÿ
                    totalBrightness += (data[i] + data[i+1] + data[i+2]) / 3;
                }
                const avgBrightness = totalBrightness / (data.length / 40);

                if (avgBrightness < 128) {
                    console.log("åµæ¸¬åˆ°æ·±è‰²åœ–ç‰‡ï¼Œæ­£åœ¨åè½‰é¡è‰²...");
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];     // R
                        data[i + 1] = 255 - data[i + 1]; // G
                        data[i + 2] = 255 - data[i + 2]; // B
                    }
                    ctx.putImageData(imageData, 0, 0);
                }
                
                resolve(canvas.toDataURL());
            };
            img.src = URL.createObjectURL(file);
        });
    }

    // å¯¬é¬†è§£æé‚è¼¯
    function parseLooseText(text) {
        const lines = text.split('\n');
        const result = [];

        lines.forEach(line => {
            // ç§»é™¤æ‰€æœ‰ç©ºç™½ï¼Œé¿å… OCR ç”¢ç”Ÿçš„ç©ºæ ¼å¹²æ“¾
            // ä½†ä¿ç•™æ•¸å­—é–“çš„å€éš”ï¼Œæ‰€ä»¥å…ˆæŠŠé€£çºŒç©ºç™½è®Šæˆä¸€å€‹ç©ºæ ¼
            let clean = line.trim().replace(/\s+/g, ' ');

            // ç­–ç•¥ï¼šå°‹æ‰¾ä¸€è¡Œè£¡é¢åŒæ™‚å‡ºç¾ "å¿…" æˆ– "é¸"ï¼Œä»¥åŠä¸€å€‹ "æ•¸å­—"
            // å¾ˆå¤šæ™‚å€™ OCR æœƒæŠŠ "å¿… 3" çœ‹æˆ "å¿…3"
            if (clean.includes('å¿…') || clean.includes('é¸')) {
                
                // å˜—è©¦æŠ“å–å­¸åˆ† (é€šå¸¸æ˜¯ 0, 1, 2, 3, 4)
                // æ‰¾ "å¿…" æˆ– "é¸" å¾Œé¢è·Ÿè‘—çš„æ•¸å­—
                let creditMatch = clean.match(/(å¿…|é¸).*?(\d)/);
                
                // å¦‚æœæ²’æŠ“åˆ°ï¼Œè©¦è©¦çœ‹å‰é¢æœ‰æ²’æœ‰æ•¸å­— (æœ‰æ™‚å€™æ’ç‰ˆå•é¡Œ)
                if (!creditMatch) {
                    creditMatch = clean.match(/(\d).*?(å¿…|é¸)/);
                }

                if (creditMatch) {
                    // å‡è¨­é€™è¡Œæ˜¯èª²ç¨‹
                    // æŠŠåå­—æŠ“å‡ºä¾† (æŠŠå¿…/é¸/æ•¸å­—/äº‚ç¢¼æ¿¾æ‰å‰©ä¸‹çš„é•·å­—ä¸²)
                    // é€™æ¯”è¼ƒé›£ç²¾æº–ï¼Œæˆ‘å€‘å…ˆç”¨åˆ†å‰²æ³•
                    
                    let parts = clean.split(' ');
                    // é€šå¸¸æœ€é•·çš„é‚£ä¸€æ®µæ˜¯èª²å
                    let name = parts.reduce((a, b) => a.length > b.length ? a : b, '');
                    
                    // ä¿®æ­£ OCR å¸¸è¦‹éŒ¯å­—
                    name = name.replace(/[^\u4e00-\u9fa5a-zA-Z\(\)]/g, ''); // åªç•™ä¸­è‹±æ–‡æ‹¬è™Ÿ

                    let type = clean.includes('å¿…') ? 'å¿…' : 'é¸';
                    // æŠ“åˆ°çš„æ•¸å­—
                    let credit = parseInt(clean.match(/\d/)[0]); 

                    // ç°¡å–®éæ¿¾ï¼šå­¸åˆ†ä¸å¤ªå¯èƒ½å¤§æ–¼ 6 æˆ–å°æ–¼ 0
                    if (credit >= 0 && credit <= 6 && name.length > 1) {
                        result.push({
                            id: Date.now() + Math.random(),
                            name: name,
                            type: type,
                            credit: credit,
                            components: [{ name: 'æœŸæœ«', score: '', weight: 100 }]
                        });
                    }
                }
            }
        });
        return result;
    }

    // --- ä»‹é¢æ¸²æŸ“ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
    function render() {
        const list = document.getElementById('courseList');
        const emptyMsg = document.getElementById('emptyMsg');
        
        if(courses.length === 0) {
            list.innerHTML = '';
            emptyMsg.style.display = 'block';
            updateFooter(0,0,0,0);
            return;
        }
        emptyMsg.style.display = 'none';
        list.innerHTML = '';

        let totalCr=0, earnedCr=0, failedCr=0, wScore=0, validCr=0;

        courses.forEach((c, idx) => {
            // ç®—åˆ†
            let score=0, weight=0;
            c.components.forEach(cmp => {
                score += (parseFloat(cmp.score)||0)*(parseFloat(cmp.weight||0)/100);
                weight += parseFloat(cmp.weight)||0;
            });
            const final = Math.round(score);
            const cr = parseFloat(c.credit)||0;

            totalCr += cr;
            if(final>=60) earnedCr += cr;
            else if(cr>0) failedCr += cr;

            if(cr>0) { wScore += final*cr; validCr += cr; }

            // UI
            const div = document.createElement('div');
            div.className = 'course-item';
            div.innerHTML = `
                <div class="course-summary">
                    <div style="text-align:center; color:#888;">${idx+1}</div>
                    <div>
                        <input type="text" class="input-name" value="${c.name}" onchange="upd(${idx}, 'name', this.value)">
                        <div class="mobile-info" style="display:${window.innerWidth<=600?'flex':'none'}">
                            <span>${c.type}</span> <span>${c.credit}å­¸åˆ†</span>
                        </div>
                    </div>
                    <div class="desktop-only">
                        <select onchange="upd(${idx}, 'type', this.value)">
                            <option value="å¿…" ${c.type==='å¿…'?'selected':''}>å¿…</option>
                            <option value="é¸" ${c.type==='é¸'?'selected':''}>é¸</option>
                        </select>
                    </div>
                    <div class="desktop-only">
                        <input type="number" value="${c.credit}" onchange="upd(${idx}, 'credit', this.value)">
                    </div>
                    <div class="score-display" style="color:${final<60?'#ff6b6b':'#fff'}">
                        ${weight>0?final:'-'}
                    </div>
                    <button onclick="del(${idx})" style="background:none; border:none; color:#666;">Ã—</button>
                </div>
            `;
            list.appendChild(div);
        });

        const avg = validCr>0 ? (wScore/validCr) : 0;
        updateFooter(totalCr, earnedCr, failedCr, avg);
    }

    function updateFooter(t, e, f, a) {
        document.getElementById('totalCredits').innerText = t;
        document.getElementById('earnedCredits').innerText = e;
        document.getElementById('failedCredits').innerText = f;
        document.getElementById('semesterAvg').innerText = a.toFixed(2);
    }

    function upd(idx, key, val) { courses[idx][key] = val; render(); }
    function del(idx) { if(confirm('åˆªé™¤?')) { courses.splice(idx,1); render(); } }

    render();
</script>

</body>
</html>
