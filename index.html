<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸æœŸæˆç¸¾è¨ˆç®— (ç©ºç™½ç‰ˆ)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg-body: #2d3e46;
            --bg-card: #3b4c54;
            --text-main: #e0e6ed;
            --text-muted: #aab2bd;
            --accent-cyan: #4ecdc4;
            --accent-gold: #ffd700;
            --accent-red: #ff6b6b;
            --border: #4a5d66;
            --input-bg: #455a64;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 150px; /* ç•™çµ¦åº•éƒ¨çµ±è¨ˆç©ºé–“ */
        }

        .container { max-width: 800px; margin: 0 auto; }

        h2 { text-align: center; color: var(--text-main); margin-bottom: 15px; }

        /* æ§åˆ¶å€ */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn-ocr {
            background: #546e7a;
            color: white;
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }

        /* ç©ºç™½ç‹€æ…‹æç¤º */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            border: 2px dashed var(--border);
            border-radius: 10px;
            margin-top: 20px;
        }

        /* è¼‰å…¥æ¢ */
        .progress-bar {
            width: 100%; height: 4px; background: #333; margin-top: 10px;
            border-radius: 2px; overflow: hidden; display: none;
        }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-cyan); transition: width 0.3s; }
        .ocr-status { text-align: center; font-size: 0.85rem; color: var(--accent-cyan); margin-top: 5px; height: 20px;}

        /* åˆ—è¡¨æ¨£å¼ */
        .list-header {
            display: grid;
            grid-template-columns: 30px 1fr 50px 50px 60px 30px;
            padding: 10px;
            font-weight: bold;
            color: var(--accent-gold);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
            text-align: center;
        }
        .list-header div:nth-child(2) { text-align: left; }

        .course-item {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin-bottom: 2px;
            border-radius: 4px;
        }

        .course-summary {
            display: grid;
            grid-template-columns: 30px 1fr 50px 50px 60px 30px;
            padding: 12px 10px;
            align-items: center;
            cursor: pointer;
        }

        .course-index { font-family: monospace; color: var(--text-muted); text-align: center; }

        input, select {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            font-size: 1rem;
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            outline: none;
            text-align: center;
        }
        .input-name { text-align: left; font-weight: bold; }
        input:focus { background: var(--input-bg); border-bottom: 2px solid var(--accent-cyan); }

        .score-display { font-weight: bold; font-size: 1.1rem; text-align: center; }

        /* ç´°é …è¨ˆç®—å€ */
        .calc-area {
            display: none;
            background: #263238;
            padding: 15px;
            border-top: 1px dashed #546e7a;
        }
        .calc-active { display: block; animation: fadeIn 0.3s; }

        .comp-row { display: flex; gap: 5px; margin-bottom: 8px; margin-left: 30px; }
        .comp-row input { background: var(--bg-body); border: 1px solid var(--border); font-size: 0.9rem; }

        /* åº•éƒ¨çµ±è¨ˆ */
        .footer-stats {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #263238;
            border-top: 3px solid var(--accent-cyan);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 15px 5px;
            z-index: 100;
        }
        .stat-box { text-align: center; border-right: 1px solid var(--border); }
        .stat-box:last-child { border-right: none; }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; margin-bottom: 3px; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: white; }
        .stat-val.avg { color: var(--accent-gold); font-size: 1.4rem; }

        .fab-add {
            position: fixed; bottom: 100px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--accent-gold); color: #2d3e46;
            font-size: 30px; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer; z-index: 101;
            display: flex; align-items: center; justify-content: center;
        }

        /* RWD */
        @media (max-width: 600px) {
            .list-header { display: none; }
            .course-summary {
                grid-template-columns: 25px 1fr auto;
                grid-template-areas: "idx name score" "idx info score";
                gap: 5px;
            }
            .course-index { grid-area: idx; align-self: start; padding-top: 8px; }
            .input-name { grid-area: name; font-size: 1.1rem; }
            .mobile-info { 
                grid-area: info; display: flex; gap: 10px; 
                font-size: 0.85rem; color: var(--text-muted);
            }
            .score-display { grid-area: score; text-align: right; min-width: 40px; }
            .desktop-only { display: none; }
            .comp-row { margin-left: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2>å­¸æœŸæˆç¸¾è¨ˆç®—</h2>

    <div class="controls">
        <button class="btn-ocr" onclick="document.getElementById('fileInput').click()">
            ğŸ“· æˆªåœ–è­˜åˆ¥
        </button>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImage(this)">
    </div>

    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="ocr-status" id="ocrStatus"></div>

    <div class="list-header">
        <div>#</div><div>èª²ç¨‹åç¨±</div><div>ä¿®åˆ¥</div><div>å­¸åˆ†</div><div>ç¸½åˆ†</div><div></div>
    </div>

    <div id="courseList"></div>
    <div id="emptyMsg" class="empty-state">ç›®å‰ç„¡è³‡æ–™<br>è«‹é»æ“Šå³ä¸‹è§’ã€Œ+ã€æˆ–ä¸Šæ–¹ã€Œæˆªåœ–è­˜åˆ¥ã€</div>

    <div style="text-align: center; margin-top: 30px; margin-bottom: 20px;">
        <button onclick="clearAll()" style="background:none; border:none; color: #666; text-decoration:underline; cursor:pointer;">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<div class="footer-stats">
    <div class="stat-box"><div class="stat-label">ç¸½å­¸åˆ†</div><div class="stat-val" id="totalCredits">0</div></div>
    <div class="stat-box"><div class="stat-label">å¯¦å¾—å­¸åˆ†</div><div class="stat-val" id="earnedCredits">0</div></div>
    <div class="stat-box"><div class="stat-label">ä¸åŠæ ¼</div><div class="stat-val" id="failedCredits" style="color:var(--accent-red)">0</div></div>
    <div class="stat-box"><div class="stat-label">å­¸æœŸå¹³å‡</div><div class="stat-val avg" id="semesterAvg">0.0</div></div>
</div>

<button class="fab-add" onclick="addCourse()">+</button>

<script>
    // é è¨­ç‚ºç©ºé™£åˆ—
    let courses = JSON.parse(localStorage.getItem('myGrades_clean')) || [];

    // --- æ ¸å¿ƒæ¸²æŸ“èˆ‡è¨ˆç®— ---
    function render() {
        const list = document.getElementById('courseList');
        const emptyMsg = document.getElementById('emptyMsg');
        
        // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
        if (courses.length === 0) {
            list.innerHTML = '';
            emptyMsg.style.display = 'block';
            updateFooterStats(0, 0, 0, 0);
            return;
        } else {
            emptyMsg.style.display = 'none';
        }

        // åªæœ‰ç•¶åˆ—è¡¨é•·åº¦æ”¹è®Šæ™‚ï¼Œæ‰å®Œå…¨é‡å»º DOM (é¿å…è¼¸å…¥ä¸­æ–·)
        // é€™è£¡æ¡ç”¨ç°¡å–®ç­–ç•¥ï¼šå¦‚æœ list å…§å…ƒç´ æ•¸é‡è·Ÿæ•¸æ“šä¸ç¬¦ï¼Œå°±é‡å»ºã€‚
        // å¦‚æœç¬¦åˆï¼Œæˆ‘å€‘å‡è¨­æ˜¯æ›´æ–°æ“ä½œï¼Œé€™éƒ¨åˆ†åœ¨ update å‡½æ•¸è™•ç†ã€‚
        // ä½†ç‚ºäº†ä»£ç¢¼ç°¡å–®ä¸”é¿å… OCR å¾Œå‡ºéŒ¯ï¼Œé€™è£¡é‚„æ˜¯æ¯æ¬¡ render éƒ½é‡å»º
        // **ä¿®æ­£**ï¼šç‚ºäº†ä¸å¡é “ï¼Œè¼¸å…¥æ¡†ä¸ç¶å®š oninput -> renderï¼Œè€Œæ˜¯ oninput -> updateData -> updateSingleRow
        
        list.innerHTML = ''; 
        let totalCr = 0, earnedCr = 0, failedCr = 0, weightedScoreSum = 0, validCredits = 0;

        courses.forEach((c, idx) => {
            // è¨ˆç®—æ•¸å€¼
            const stats = calcCourseStats(c);
            
            totalCr += stats.credit;
            if (stats.finalScore >= 60) earnedCr += stats.credit;
            else if(stats.credit > 0) failedCr += stats.credit;

            if (stats.credit > 0) {
                weightedScoreSum += stats.finalScore * stats.credit;
                validCredits += stats.credit;
            }

            // å»ºç«‹ HTML
            const item = document.createElement('div');
            item.className = 'course-item';
            item.innerHTML = `
                <div class="course-summary" onclick="toggleCalc(${idx})">
                    <div class="course-index">${idx + 1}</div>
                    <div style="width:100%">
                        <input type="text" class="input-name" value="${c.name}" onclick="event.stopPropagation()"
                            oninput="updateField(${idx}, 'name', this.value)">
                        <div class="mobile-info" style="display:${window.innerWidth<=600?'flex':'none'}">
                            <span>${c.type}ä¿®</span>
                            <span>${c.credit}å­¸åˆ†</span>
                        </div>
                    </div>
                    <div class="desktop-only">
                        <select oninput="updateField(${idx}, 'type', this.value)" onclick="event.stopPropagation()">
                            <option value="å¿…" ${c.type==='å¿…'?'selected':''}>å¿…</option>
                            <option value="é¸" ${c.type==='é¸'?'selected':''}>é¸</option>
                        </select>
                    </div>
                    <div class="desktop-only">
                        <input type="number" value="${c.credit}" onclick="event.stopPropagation()"
                            oninput="updateField(${idx}, 'credit', this.value)">
                    </div>
                    <div class="score-display" id="score-disp-${idx}" style="color:${stats.finalScore<60?'#ff6b6b':'#fff'}">
                        ${stats.totalWeight > 0 ? stats.finalScore : '-'}
                    </div>
                    <button onclick="delCourse(event, ${idx})" style="border:none; background:none; color:#666; cursor:pointer;">Ã—</button>
                </div>
                <div class="calc-area" id="calc-${idx}">
                    <div style="margin-bottom:8px; color:#aaa; font-size:0.85rem;">
                        é…åˆ†è¨­å®š (ç›®å‰åˆè¨ˆ: <span id="weight-alert-${idx}" style="color:${stats.totalWeight!==100?'#ff6b6b':'#4ecdc4'}">${stats.totalWeight}%</span>)
                    </div>
                    <div id="comps-${idx}">
                        ${c.components.map((comp, cIdx) => `
                            <div class="comp-row">
                                <input type="text" style="flex:2" placeholder="é …ç›®" value="${comp.name}" 
                                    oninput="updateComp(${idx}, ${cIdx}, 'name', this.value)">
                                <input type="number" style="flex:1" placeholder="åˆ†æ•¸" value="${comp.score}" 
                                    oninput="updateComp(${idx}, ${cIdx}, 'score', this.value)">
                                <input type="number" style="flex:1" placeholder="%" value="${comp.weight}" 
                                    oninput="updateComp(${idx}, ${cIdx}, 'weight', this.value)">
                                <button onclick="delComp(${idx}, ${cIdx})" style="color:#ff6b6b; border:none; background:none;">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:10px; margin-left:30px;">
                        <button onclick="addComp(${idx})" style="background:none; border:1px dashed #666; color:#aaa; padding:5px 10px; border-radius:4px; cursor:pointer;">+ æ–°å¢é …ç›®</button>
                    </div>
                </div>
            `;
            list.appendChild(item);
        });

        const avg = validCredits > 0 ? (weightedScoreSum / validCredits) : 0;
        updateFooterStats(totalCr, earnedCr, failedCr, avg);
    }

    // --- è¨ˆç®—è¼”åŠ© ---
    function calcCourseStats(c) {
        let score = 0, weight = 0;
        c.components.forEach(comp => {
            score += (parseFloat(comp.score)||0) * ((parseFloat(comp.weight)||0)/100);
            weight += (parseFloat(comp.weight)||0);
        });
        return {
            finalScore: Math.round(score),
            totalWeight: weight,
            credit: parseFloat(c.credit) || 0
        };
    }

    function updateFooterStats(total, earned, failed, avg) {
        document.getElementById('totalCredits').innerText = total;
        document.getElementById('earnedCredits').innerText = earned;
        document.getElementById('failedCredits').innerText = failed;
        document.getElementById('semesterAvg').innerText = avg.toFixed(2);
    }

    function recalculateAll() {
        let totalCr = 0, earnedCr = 0, failedCr = 0, weightedScoreSum = 0, validCredits = 0;
        courses.forEach(c => {
            const stats = calcCourseStats(c);
            totalCr += stats.credit;
            if (stats.finalScore >= 60) earnedCr += stats.credit;
            else if(stats.credit > 0) failedCr += stats.credit;
            if (stats.credit > 0) {
                weightedScoreSum += stats.finalScore * stats.credit;
                validCredits += stats.credit;
            }
        });
        const avg = validCredits > 0 ? (weightedScoreSum / validCredits) : 0;
        updateFooterStats(totalCr, earnedCr, failedCr, avg);
    }

    // --- è³‡æ–™æ“ä½œ (ä¸é‡ç¹ª DOM) ---
    function updateField(idx, key, val) {
        courses[idx][key] = val;
        save();
        recalculateAll(); // åªæ›´æ–°åº•éƒ¨çµ±è¨ˆ
    }

    function updateComp(idx, cIdx, key, val) {
        courses[idx].components[cIdx][key] = val;
        save();
        
        // å±€éƒ¨æ›´æ–°è©²è¡Œé¡¯ç¤ºï¼Œä¸é‡ç¹ªæ•´å€‹åˆ—è¡¨
        const stats = calcCourseStats(courses[idx]);
        const scoreDisp = document.getElementById(`score-disp-${idx}`);
        const weightAlert = document.getElementById(`weight-alert-${idx}`);
        
        if (scoreDisp) {
            scoreDisp.innerText = stats.totalWeight > 0 ? stats.finalScore : '-';
            scoreDisp.style.color = stats.finalScore < 60 ? '#ff6b6b' : '#fff';
        }
        if (weightAlert) {
            weightAlert.innerText = stats.totalWeight + '%';
            weightAlert.style.color = stats.totalWeight !== 100 ? '#ff6b6b' : '#4ecdc4';
        }
        recalculateAll();
    }

    // --- å¢åˆªæ“ä½œ (éœ€é‡ç¹ª) ---
    function addCourse() {
        courses.push({
            id: Date.now(), name: '', type: 'å¿…', credit: 3,
            components: [{name:'æœŸä¸­', score:'', weight:30}, {name:'æœŸæœ«', score:'', weight:40}, {name:'å¹³æ™‚', score:'', weight:30}]
        });
        render();
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
        save();
    }

    function delCourse(e, idx) {
        e.stopPropagation();
        if(confirm('åˆªé™¤æ­¤èª²ç¨‹ï¼Ÿ')) { courses.splice(idx, 1); render(); save(); }
    }

    function addComp(idx) {
        courses[idx].components.push({name:'', score:'', weight:''});
        render();
        setTimeout(() => document.getElementById(`calc-${idx}`).style.display='block', 50); // ä¿æŒå±•é–‹
        save();
    }

    function delComp(idx, cIdx) {
        courses[idx].components.splice(cIdx, 1);
        render();
        setTimeout(() => document.getElementById(`calc-${idx}`).style.display='block', 50);
        save();
    }

    function clearAll() {
        if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ')) { courses = []; render(); save(); }
    }

    function save() {
        localStorage.setItem('myGrades_clean', JSON.stringify(courses));
    }

    function toggleCalc(idx) {
        if(['INPUT','SELECT','BUTTON'].includes(event.target.tagName)) return;
        const el = document.getElementById(`calc-${idx}`);
        const isHidden = el.style.display === 'none' || !el.style.display;
        document.querySelectorAll('.calc-area').forEach(d => d.style.display='none'); // æ”¶èµ·å…¶ä»–
        if(isHidden) {
            el.style.display = 'block';
            el.classList.add('calc-active');
        }
    }

    // --- OCR é‚è¼¯ ---
    async function handleImage(input) {
        if (!input.files[0]) return;
        const status = document.getElementById('ocrStatus');
        const bar = document.getElementById('progressBar');
        const fill = document.getElementById('progressFill');
        
        bar.style.display = 'block';
        status.innerText = "æ­£åœ¨åˆå§‹åŒ–è­˜åˆ¥å¼•æ“...";

        try {
            const worker = Tesseract.createWorker({
                logger: m => {
                    if(m.status === 'recognizing text') {
                        fill.style.width = `${m.progress * 100}%`;
                        status.innerText = `è®€å–ä¸­... ${Math.round(m.progress * 100)}%`;
                    }
                }
            });
            await worker.load();
            await worker.loadLanguage('chi_tra');
            await worker.initialize('chi_tra');

            const { data: { text } } = await worker.recognize(input.files[0]);
            const newCourses = parseScheduleText(text);
            await worker.terminate();

            if (newCourses.length > 0) {
                courses = [...courses, ...newCourses];
                render();
                save();
                alert(`è­˜åˆ¥æˆåŠŸï¼å·²æ–°å¢ ${newCourses.length} é–€èª²ç¨‹ã€‚`);
            } else {
                alert("ç„¡æ³•è­˜åˆ¥èª²ç¨‹ï¼Œè«‹ç¢ºèªåœ–ç‰‡æ¸…æ™°åº¦ã€‚");
            }
        } catch (e) {
            alert("éŒ¯èª¤ï¼š" + e.message);
        } finally {
            bar.style.display = 'none';
            status.innerText = "";
            input.value = ''; // é‡ç½® input ä»¥ä¾¿é‡è¤‡ä¸Šå‚³
        }
    }

    function parseScheduleText(text) {
        const lines = text.split('\n');
        const result = [];
        lines.forEach(line => {
            let clean = line.trim().replace(/\s+/g, ' '); 
            // è¦å‰‡ï¼šæŠ“å–çµå°¾æ˜¯ "å¿…/é¸ N/N" æˆ– "å¿…/é¸ N" çš„è¡Œ
            const regex = /([^\s\d].*?)\s+.*?(å¿…|é¸)\s+(\d)(\/\d)?$/;
            const match = clean.match(regex);
            if (match) {
                let name = match[1].split('æ˜ŸæœŸ')[0].trim();
                result.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    type: match[2],
                    credit: parseInt(match[3]),
                    components: [{ name: 'æœŸæœ«', score: '', weight: 100 }]
                });
            }
        });
        return result;
    }

    // å•Ÿå‹•
    render();
</script>

</body>
</html>
