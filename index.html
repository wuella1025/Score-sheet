<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>學期成績計算 (純淨版)</title>
    <style>
        :root {
            /* 學校系統風格配色 */
            --bg-body: #2d3e46;
            --bg-card: #3b4c54;
            --text-main: #e0e6ed;
            --text-muted: #aab2bd;
            --accent-cyan: #4ecdc4;
            --accent-gold: #ffd700;
            --accent-red: #ff6b6b;
            --border: #4a5d66;
            --input-bg: #455a64;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 140px; /* 底部空間 */
        }

        .container { max-width: 900px; margin: 0 auto; }

        h2 { text-align: center; color: var(--text-main); margin-bottom: 20px; letter-spacing: 1px; }

        /* 表頭 (電腦版顯示) */
        .list-header {
            display: grid;
            grid-template-columns: 40px 1fr 60px 60px 80px 40px;
            padding: 10px 15px;
            font-weight: bold;
            color: var(--accent-gold);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
            text-align: center;
        }
        .list-header div:nth-child(2) { text-align: left; }

        /* 課程卡片/列 */
        .course-item {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin-bottom: 2px;
            transition: background 0.2s;
        }
        
        /* 主要資訊列 */
        .course-summary {
            display: grid;
            grid-template-columns: 40px 1fr 60px 60px 80px 40px;
            padding: 12px 10px;
            align-items: center;
            cursor: pointer;
        }

        /* 輸入框樣式 */
        input, select {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            font-size: 1rem;
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            outline: none;
            text-align: center;
        }
        .input-name { text-align: left; font-weight: bold; }
        
        input:focus, select:focus {
            background: var(--input-bg);
            border-bottom: 2px solid var(--accent-cyan);
        }

        /* 分數顯示 */
        .score-display { font-weight: bold; font-size: 1.2rem; text-align: center; }

        /* 細項展開區 */
        .calc-area {
            display: none;
            background: #263238;
            padding: 15px;
            border-top: 1px dashed #546e7a;
            animation: fadeIn 0.2s;
        }
        
        .comp-row {
            display: flex; gap: 10px; margin-bottom: 10px; 
            max-width: 600px; margin-left: 40px;
        }
        .comp-row input {
            background: var(--bg-body);
            border: 1px solid var(--border);
        }

        /* 底部統計列 */
        .footer-stats {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #263238;
            border-top: 4px solid var(--accent-cyan);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 15px 0;
            z-index: 100;
        }
        .stat-box { text-align: center; border-right: 1px solid var(--border); }
        .stat-box:last-child { border-right: none; }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; margin-bottom: 4px; }
        .stat-val { font-size: 1.3rem; font-weight: bold; color: white; }
        
        /* 新增按鈕 (懸浮) */
        .fab-add {
            position: fixed; bottom: 100px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--accent-gold); color: #2d3e46;
            font-size: 32px; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            cursor: pointer; z-index: 101;
            display: flex; align-items: center; justify-content: center;
        }

        /* 手機版適配 */
        @media (max-width: 600px) {
            .list-header { display: none; }
            
            .course-summary {
                grid-template-columns: 30px 1fr auto; /* 序號 | 名字 | 分數 */
                grid-template-areas: 
                    "idx name score"
                    "idx info score";
                gap: 5px;
            }

            .course-index { grid-area: idx; padding-top: 8px; text-align: center; color: #888; }
            .input-name { grid-area: name; font-size: 1.1rem; }
            
            .mobile-info {
                grid-area: info;
                display: flex; gap: 10px;
                color: var(--text-muted); font-size: 0.9rem;
            }

            .score-cell { grid-area: score; text-align: right; }
            .desktop-only { display: none; }
            
            .comp-row { margin-left: 0; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2>學期成績紀錄表</h2>

    <div class="list-header">
        <div>#</div>
        <div>課程名稱</div>
        <div>修別</div>
        <div>學分</div>
        <div>總成績</div>
        <div></div>
    </div>

    <div id="courseList"></div>

    <div style="text-align: center; margin-top: 30px; color: #666;">
        <button onclick="clearAll()" style="background:none; border:none; color: #546e7a; text-decoration:underline; cursor:pointer;">重置所有資料</button>
    </div>
</div>

<div class="footer-stats">
    <div class="stat-box">
        <div class="stat-label">總修習學分</div>
        <div class="stat-val" id="totalCredits">0</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">不及格學分</div>
        <div class="stat-val" id="failedCredits" style="color: var(--accent-red)">0</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">實得學分</div>
        <div class="stat-val" id="earnedCredits">0</div>
    </div>
    <div class="stat-box">
        <div class="stat-label">學期平均</div>
        <div class="stat-val" id="semesterAvg" style="color: var(--accent-gold)">0.00</div>
    </div>
</div>

<button class="fab-add" onclick="addCourse()">+</button>

<script>
    // 讀取紀錄或使用預設範例
    let courses = JSON.parse(localStorage.getItem('finalGrades')) || [
        { 
            id: Date.now(), 
            name: '', 
            type: '必', 
            credit: 3, 
            components: [
                {name: '期中', score: '', weight: 30},
                {name: '期末', score: '', weight: 40},
                {name: '平時', score: '', weight: 30}
            ] 
        }
    ];

    // 初始化
    renderList(); 
    updateStats();

    // 1. 渲染列表 (只在新增/刪除時完全重繪，打字時不重繪)
    function renderList() {
        const list = document.getElementById('courseList');
        list.innerHTML = '';

        courses.forEach((c, index) => {
            const row = document.createElement('div');
            row.className = 'course-item';
            
            // 計算目前分數
            const stats = calculateSingle(c);

            row.innerHTML = `
                <div class="course-summary" onclick="toggleDetail(${index})">
                    <div class="course-index">${index + 1}</div>
                    
                    <div style="width:100%">
                        <input type="text" class="input-name" placeholder="課程名稱" value="${c.name}" 
                            onclick="event.stopPropagation()"
                            oninput="updateData(${index}, 'name', this.value)">
                        
                        <div class="mobile-info" style="display:${window.innerWidth<=600?'flex':'none'}">
                            <span>${c.type}修</span>
                            <span>${c.credit}學分</span>
                        </div>
                    </div>

                    <div class="desktop-only">
                        <select oninput="updateData(${index}, 'type', this.value)" onclick="event.stopPropagation()">
                            <option value="必" ${c.type === '必' ? 'selected' : ''}>必</option>
                            <option value="選" ${c.type === '選' ? 'selected' : ''}>選</option>
                        </select>
                    </div>
                    <div class="desktop-only">
                        <input type="number" placeholder="學分" value="${c.credit}" 
                            onclick="event.stopPropagation()"
                            oninput="updateData(${index}, 'credit', this.value)">
                    </div>

                    <div class="score-cell">
                        <div class="score-display" id="score-display-${index}" style="color: ${stats.color}">
                            ${stats.text}
                        </div>
                    </div>
                    
                    <button class="desktop-only" onclick="deleteCourse(event, ${index})" 
                        style="background:none; border:none; color:#666; cursor:pointer;">×</button>
                </div>

                <div class="calc-area" id="detail-${index}">
                    <div style="margin-bottom:10px; color:#aaa; font-size:0.9rem;">
                        配分設定 (目前合計: <span id="weight-sum-${index}">${stats.totalWeight}%</span>)
                    </div>
                    
                    <div class="mobile-info" style="display:${window.innerWidth<=600?'flex':'none'}; margin-bottom:10px; gap:10px;">
                        <select style="background:#2d3e46; border:1px solid #4a5d66; padding:5px; color:#fff;"
                             oninput="updateData(${index}, 'type', this.value)">
                            <option value="必" ${c.type === '必' ? 'selected' : ''}>必修</option>
                            <option value="選" ${c.type === '選' ? 'selected' : ''}>選修</option>
                        </select>
                        <input type="number" style="background:#2d3e46; border:1px solid #4a5d66; padding:5px; width:60px;" 
                             value="${c.credit}" placeholder="學分"
                             oninput="updateData(${index}, 'credit', this.value)">
                    </div>

                    <div id="comps-list-${index}">
                        ${c.components.map((comp, cIdx) => `
                            <div class="comp-row">
                                <input type="text" style="flex:2" placeholder="項目" value="${comp.name}"
                                    oninput="updateComp(${index}, ${cIdx}, 'name', this.value)">
                                <input type="number" style="flex:1" placeholder="分數" value="${comp.score}"
                                    oninput="updateComp(${index}, ${cIdx}, 'score', this.value)">
                                <input type="number" style="flex:1" placeholder="%" value="${comp.weight}"
                                    oninput="updateComp(${index}, ${cIdx}, 'weight', this.value)">
                                <button onclick="deleteComp(${index}, ${cIdx})" 
                                    style="color:#ff6b6b; background:none; border:none;">×</button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top:10px; margin-left: 40px;">
                        <button onclick="addComp(${index})" 
                            style="border:1px dashed #666; background:none; color:#aaa; padding:5px 10px; border-radius:4px;">
                            + 新增項目
                        </button>
                        <button onclick="deleteCourse(event, ${index})" 
                            style="margin-left:10px; color:#ff6b6b; background:none; border:none;">
                            刪除此課程
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(row);
        });
    }

    // 2. 數據更新 (不重繪 DOM，保證打字流暢)
    function updateData(index, key, value) {
        courses[index][key] = value;
        save();
        updateRowDisplay(index); // 更新該行的分數顯示
        updateStats(); // 更新底部總分
    }

    function updateComp(index, compIndex, key, value) {
        courses[index].components[compIndex][key] = value;
        save();
        updateRowDisplay(index);
        updateStats();
    }

    // 計算單科分數與狀態
    function calculateSingle(course) {
        let score = 0;
        let weight = 0;
        course.components.forEach(c => {
            const s = parseFloat(c.score) || 0;
            const w = parseFloat(c.weight) || 0;
            score += s * (w / 100);
            weight += w;
        });
        
        const finalScore = Math.round(score);
        const isPass = finalScore >= 60;
        
        return {
            finalScore: finalScore,
            totalWeight: weight,
            text: weight > 0 ? finalScore : '-',
            color: weight > 0 ? (isPass ? '#fff' : '#ff6b6b') : '#666'
        };
    }

    // 更新單行的顯示 (分數、權重警告)
    function updateRowDisplay(index) {
        const stats = calculateSingle(courses[index]);
        
        // 更新分數顯示
        const scoreEl = document.getElementById(`score-display-${index}`);
        if(scoreEl) {
            scoreEl.innerText = stats.text;
            scoreEl.style.color = stats.color;
        }

        // 更新權重合計顯示
        const weightEl = document.getElementById(`weight-sum-${index}`);
        if(weightEl) {
            weightEl.innerText = stats.totalWeight + '%';
            weightEl.style.color = stats.totalWeight !== 100 ? '#ff6b6b' : '#4ecdc4';
        }
    }

    // 更新底部統計
    function updateStats() {
        let totalAttempted = 0;
        let totalFailed = 0;
        let totalEarned = 0;
        let weightedSum = 0;
        let gpaCredits = 0;

        courses.forEach(c => {
            const stats = calculateSingle(c);
            const credit = parseFloat(c.credit) || 0;
            
            totalAttempted += credit;
            
            if (stats.finalScore >= 60) {
                totalEarned += credit;
            } else if (credit > 0) { // 只有學分>0才算不及格學分
                totalFailed += credit;
            }

            // 平均只算有學分的課 (體育0學分不影響平均)
            if (credit > 0) {
                weightedSum += stats.finalScore * credit;
                gpaCredits += credit;
            }
        });

        document.getElementById('totalCredits').innerText = totalAttempted;
        document.getElementById('failedCredits').innerText = totalFailed;
        document.getElementById('earnedCredits').innerText = totalEarned;
        
        const avg = gpaCredits > 0 ? (weightedSum / gpaCredits) : 0;
        document.getElementById('semesterAvg').innerText = avg.toFixed(2);
    }

    // 操作功能
    function addCourse() {
        courses.push({
            id: Date.now(), name: '', type: '必', credit: 3,
            components: [
                {name: '期中', score: '', weight: 30},
                {name: '期末', score: '', weight: 40},
                {name: '平時', score: '', weight: 30}
            ]
        });
        renderList();
        save();
        // 捲動到底部
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    }

    function deleteCourse(e, index) {
        e.stopPropagation(); // 避免觸發展開
        if(confirm('確定刪除此課程？')) {
            courses.splice(index, 1);
            renderList();
            updateStats();
            save();
        }
    }

    function addComp(index) {
        courses[index].components.push({name: '', score: '', weight: ''});
        renderList();
        // 保持展開
        setTimeout(() => {
            const el = document.getElementById(`detail-${index}`);
            el.style.display = 'block';
        }, 50);
        save();
    }

    function deleteComp(index, cIdx) {
        courses[index].components.splice(cIdx, 1);
        renderList();
        setTimeout(() => {
            const el = document.getElementById(`detail-${index}`);
            el.style.display = 'block';
        }, 50);
        save();
        updateStats();
    }

    function toggleDetail(index) {
        // 如果點擊的是 input 或 select，不觸發收合
        if (['INPUT', 'SELECT', 'BUTTON'].includes(event.target.tagName)) return;
        
        const el = document.getElementById(`detail-${index}`);
        const isHidden = el.style.display === 'none' || !el.style.display;
        
        // 關閉其他展開項 (可選)
        document.querySelectorAll('.calc-area').forEach(d => d.style.display = 'none');
        
        if (isHidden) {
            el.style.display = 'block';
        }
    }

    function clearAll() {
        if(confirm('確定清空？')) {
            courses = [];
            renderList();
            updateStats();
            save();
        }
    }

    function save() {
        localStorage.setItem('finalGrades', JSON.stringify(courses));
    }

</script>

</body>
</html>
