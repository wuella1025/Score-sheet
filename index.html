<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºæ…§å­¸æœŸæˆç¸¾ç³»çµ±</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg-body: #2d3e46;
            --bg-card: #3b4c54;
            --text-main: #e0e6ed;
            --text-muted: #aab2bd;
            --accent-red: #ff6b6b;
            --accent-cyan: #4ecdc4;
            --accent-gold: #ffd700;
            --border: #4a5d66;
            --input-bg: #455a64;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 120px;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        h2 { text-align: center; color: var(--text-main); margin-bottom: 20px; }

        /* AI è­˜åˆ¥æ§åˆ¶å€ */
        .ocr-section {
            background: rgba(78, 205, 196, 0.1);
            border: 1px dashed var(--accent-cyan);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .btn-ocr {
            background: var(--accent-cyan);
            color: #2d3e46;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
        }

        .ocr-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            min-height: 20px;
        }

        #fileInput { display: none; }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-header {
            display: grid;
            grid-template-columns: 40px 1fr 60px 60px 60px 40px;
            padding: 10px 15px;
            font-weight: bold;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .course-item {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin-bottom: 1px;
        }

        .course-summary {
            display: grid;
            grid-template-columns: 40px 1fr 60px 60px 60px 40px;
            padding: 15px;
            align-items: center;
            cursor: pointer;
        }

        .course-index { font-family: monospace; color: var(--text-muted); }

        input, select {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            font-size: 1rem;
            width: 100%;
            padding: 4px;
            border-radius: 4px;
            outline: none;
            text-align: center;
        }
        
        .input-name { text-align: left; font-weight: bold; }
        
        input:focus, select:focus {
            background: var(--input-bg);
            border-bottom: 2px solid var(--accent-cyan);
        }

        .score-display { font-weight: bold; font-size: 1.1rem; }

        /* çµ±è¨ˆåˆ— */
        .footer-stats {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #3b4c54;
            border-top: 4px solid #546e7a;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            display: flex; justify-content: space-around;
            padding: 15px 10px; z-index: 100;
        }
        
        .stat-group { text-align: center; display: flex; flex-direction: column; gap: 5px; }
        .stat-label { color: var(--accent-gold); font-size: 0.8rem; font-weight: bold; }
        .stat-value { font-size: 1.2rem; font-weight: bold; }
        .stat-value.danger { color: var(--accent-red); }

        /* æ‰‹æ©Ÿ RWD */
        @media (max-width: 600px) {
            .list-header { display: none; }
            .course-summary {
                grid-template-columns: 30px 1fr auto;
                grid-template-areas: "idx name score" "idx info score";
                gap: 5px;
            }
            .course-index { grid-area: idx; align-self: start; padding-top: 5px; }
            .input-name { grid-area: name; font-size: 1.1rem; }
            .mobile-info { grid-area: info; display: flex; gap: 10px; color: var(--text-muted); font-size: 0.85rem; }
            .score-cell { grid-area: score; text-align: right; }
            .desktop-only { display: none; }
        }

        /* è¼‰å…¥å‹•ç•« */
        .progress-bar {
            width: 100%; height: 4px; background: #333; margin-top: 10px;
            border-radius: 2px; overflow: hidden; display: none;
        }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-cyan); transition: width 0.3s; }

        .fab-add {
            position: fixed; bottom: 100px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--accent-gold); color: #2d3e46;
            font-size: 30px; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer; z-index: 101;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>å­¸æœŸæˆç¸¾æ¨¡æ“¬ç³»çµ±</h2>

    <div class="ocr-section">
        <button class="btn-ocr" onclick="document.getElementById('fileInput').click()">
            ğŸ“· ä¸Šå‚³æˆªåœ–è‡ªå‹•åŒ¯å…¥
        </button>
        <input type="file" id="fileInput" accept="image/*" onchange="handleImage(this)">
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="ocr-status" id="ocrStatus">ç³»çµ±æº–å‚™å°±ç·’ï¼Œè«‹ä¸Šå‚³åŒ…å«è¡¨æ ¼çš„æˆç¸¾å–®æˆªåœ–</div>
    </div>

    <div class="list-header">
        <div>#</div><div>èª²ç¨‹</div><div>ä¿®åˆ¥</div><div>å­¸åˆ†</div><div>ç¸½æˆç¸¾</div><div></div>
    </div>

    <div id="courseList"></div>

    <div style="text-align: center; margin-top: 20px;">
        <button onclick="resetData()" style="background:none; border:none; color: #546e7a; text-decoration:underline;">æ¸…ç©ºè³‡æ–™</button>
    </div>
</div>

<div class="footer-stats">
    <div class="stat-group"><div class="stat-label">ç¸½ä¿®ç¿’</div><div class="stat-value" id="totalAttempted">0</div></div>
    <div class="stat-group"><div class="stat-label">ä¸åŠæ ¼</div><div class="stat-value danger" id="totalFailed">0</div></div>
    <div class="stat-group"><div class="stat-label">å¯¦å¾—</div><div class="stat-value" id="totalEarned">0</div></div>
    <div class="stat-group"><div class="stat-label">å¹³å‡</div><div class="stat-value" id="semesterAvg" style="color: #4ecdc4;">0.00</div></div>
</div>

<button class="fab-add" onclick="addCourse()">+</button>

<script>
    let courses = JSON.parse(localStorage.getItem('ocrGrades')) || [];

    // --- åœ–åƒè­˜åˆ¥é‚è¼¯ ---
    async function handleImage(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const statusEl = document.getElementById('ocrStatus');
        const bar = document.getElementById('progressBar');
        const fill = document.getElementById('progressFill');

        bar.style.display = 'block';
        statusEl.innerText = "æ­£åœ¨åˆå§‹åŒ–è­˜åˆ¥å¼•æ“ (é¦–æ¬¡éœ€è¦ä¸‹è¼‰ä¸­æ–‡åŒ…)...";

        try {
            // ä½¿ç”¨ Tesseract é€²è¡Œè­˜åˆ¥
            const worker = Tesseract.createWorker({
                logger: m => {
                    if(m.status === 'recognizing text') {
                        fill.style.width = `${m.progress * 100}%`;
                        statusEl.innerText = `æ­£åœ¨è®€å–æ–‡å­—... ${Math.round(m.progress * 100)}%`;
                    } else {
                        statusEl.innerText = m.status;
                    }
                }
            });

            await worker.load();
            await worker.loadLanguage('chi_tra'); // è¼‰å…¥ç¹é«”ä¸­æ–‡
            await worker.initialize('chi_tra');

            statusEl.innerText = "æ­£åœ¨åˆ†æåœ–ç‰‡...";
            const { data: { text } } = await worker.recognize(file);
            
            console.log("OCR Result:", text); // Debugç”¨
            
            // è§£ææ–‡å­—
            const newCourses = parseOCRText(text);
            
            await worker.terminate();

            if (newCourses.length > 0) {
                if(confirm(`æˆåŠŸè¾¨è­˜å‡º ${newCourses.length} é–€èª²ç¨‹ï¼æ˜¯å¦è¦è¦†è“‹ç›®å‰åˆ—è¡¨ï¼Ÿ(å–æ¶ˆå‰‡ç‚ºè¿½åŠ )`)) {
                    courses = newCourses;
                } else {
                    courses = [...courses, ...newCourses];
                }
                render();
                statusEl.innerText = `æˆåŠŸåŒ¯å…¥ ${newCourses.length} ç­†è³‡æ–™ï¼è«‹æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯å­—ã€‚`;
            } else {
                statusEl.innerText = "ç„¡æ³•è¾¨è­˜å‡ºèª²ç¨‹çµæ§‹ï¼Œè«‹ç¢ºèªæˆªåœ–æ˜¯å¦æ¸…æ™°ï¼Œæˆ–åŒ…å«å®Œæ•´çš„è¡¨æ ¼è¡Œã€‚";
            }

        } catch (error) {
            console.error(error);
            statusEl.innerText = "ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message;
        } finally {
            setTimeout(() => { bar.style.display = 'none'; fill.style.width = '0%'; }, 2000);
        }
    }

    // --- æ™ºæ…§è§£æå™¨ (é‡å°æ‚¨çš„æˆªåœ–æ ¼å¼å„ªåŒ–) ---
    function parseOCRText(text) {
        const lines = text.split('\n');
        const detectedCourses = [];
        
        // æˆªåœ–ç‰¹å¾µï¼šæ¯è¡Œçµå°¾é€šå¸¸æ˜¯ "å¿…/é¸ X XX" (ä¿®åˆ¥ å­¸åˆ† åˆ†æ•¸)
        // Regex è§£é‡‹ï¼š
        // (.*?) -> èª²ç¨‹åç¨± (Group 1)
        // (å¿…|é¸) -> ä¿®åˆ¥ (Group 2)
        // \s* -> å¯èƒ½æœ‰ç©ºç™½
        // (\d) -> å­¸åˆ† (Group 3, åªæœ‰1ä½æ•¸)
        // \s* -> å¯èƒ½æœ‰ç©ºç™½
        // (\d{1,3}) -> åˆ†æ•¸ (Group 4, 1-3ä½æ•¸)
        // $ -> è¡Œå°¾
        // æ³¨æ„ï¼šOCR ç¶“å¸¸æœƒæŠŠç©ºæ ¼åƒæ‰æˆ–å¤šåŠ ï¼Œæ‰€ä»¥æ­£å‰‡è¦å¯¬é¬†ä¸€é»
        
        // é‡å°æˆªåœ–ä¸­ "---" çš„è™•ç†ï¼Œä»¥åŠå¯èƒ½å‡ºç¾çš„ç­ç´šåç¨±éæ¿¾
        lines.forEach(line => {
            const cleanLine = line.trim().replace(/\s+/g, ' '); // å£“ç¸®ç©ºç™½
            
            // å˜—è©¦å°‹æ‰¾çµå°¾æ˜¯ "æ•¸å­— æ•¸å­—" çš„è¡Œ (å­¸åˆ† åˆ†æ•¸)
            // ä¾‹å¦‚: "... å¿… 3 72" æˆ– "å¿…3 72"
            const match = cleanLine.match(/([\u4e00-\u9fa5A-Za-z0-9\(\)\-]+)\s+(å¿…|é¸)?\s*(\d)\s+(\d{1,3})$/);

            if (match) {
                let rawName = match[1];
                const type = match[2] || 'å¿…'; // è‹¥æ²’æŠ“åˆ°é è¨­å¿…ä¿®
                const credit = match[3];
                const score = match[4];

                // æ¸…ç†åç¨±ï¼šç§»é™¤å‰é¢çš„åºè™Ÿ (å¦‚ "1 ", "10 ") å’Œ ç­ç´š (å¦‚ "æ™ºç”¢ä¸€-2")
                // é€™é‚Šç”¨ç°¡å–®éæ¿¾ï¼šç§»é™¤å‰é¢çš„ä¸€ä¸²æ•¸å­—ï¼Œå’Œå¯èƒ½çš„ "---"
                rawName = rawName.replace(/^\d+\s+/, ''); // ç§»é™¤åºè™Ÿ
                rawName = rawName.replace(/^[^\s]+\s+/, ''); // å˜—è©¦ç§»é™¤ç¬¬ä¸€å€‹å€å¡Š(é€šå¸¸æ˜¯ç­ç´š)
                rawName = rawName.replace(/---/g, ''); // ç§»é™¤åˆ†éš”ç·š

                detectedCourses.push({
                    id: Date.now() + Math.random(),
                    name: rawName.trim(),
                    type: type,
                    credit: credit,
                    components: [{ name: 'æœŸæœ«', score: score, weight: 100 }]
                });
            }
        });

        return detectedCourses;
    }

    // --- ä»‹é¢æ¸²æŸ“é‚è¼¯ (åŒå‰ç‰ˆ) ---
    const listEl = document.getElementById('courseList');
    
    function render() {
        listEl.innerHTML = '';
        let stats = { attempted: 0, failed: 0, earned: 0, weightedSum: 0, gpaCredits: 0 };

        courses.forEach((c, idx) => {
            // è¨ˆç®—åˆ†æ•¸
            let totalScore = 0;
            c.components.forEach(comp => {
                totalScore += (parseFloat(comp.score)||0) * ((parseFloat(comp.weight)||0)/100);
            });
            const finalScore = Math.round(totalScore);

            // çµ±è¨ˆ
            const credit = parseFloat(c.credit) || 0;
            stats.attempted += credit;
            if (finalScore >= 60) stats.earned += credit;
            else stats.failed += credit;
            
            if (credit > 0) { // æ’é™¤0å­¸åˆ†é«”è‚²
                stats.weightedSum += finalScore * credit;
                stats.gpaCredits += credit;
            }

            // å»ºç«‹ DOM
            const item = document.createElement('div');
            item.className = 'course-item';
            item.innerHTML = `
                <div class="course-summary">
                    <div class="course-index">${idx + 1}</div>
                    
                    <div style="width:100%">
                        <input type="text" class="input-name" value="${c.name}" onchange="update(${idx}, 'name', this.value)">
                        <div class="mobile-info" style="display:${window.innerWidth<=600?'flex':'none'}">
                            <span>${c.type}</span> <span>${c.credit}å­¸åˆ†</span>
                        </div>
                    </div>

                    <div class="desktop-only">
                        <select onchange="update(${idx}, 'type', this.value)">
                            <option value="å¿…" ${c.type==='å¿…'?'selected':''}>å¿…</option>
                            <option value="é¸" ${c.type==='é¸'?'selected':''}>é¸</option>
                        </select>
                    </div>
                    <div class="desktop-only">
                        <input type="number" value="${c.credit}" onchange="update(${idx}, 'credit', this.value)">
                    </div>

                    <div class="score-cell">
                        <div class="score-display" style="color: ${finalScore<60?'#ff6b6b':'#fff'}">${finalScore}</div>
                    </div>
                    
                    <button onclick="del(${idx})" style="border:none; background:none; color:#666; cursor:pointer;">Ã—</button>
                </div>
            `;
            listEl.appendChild(item);
        });

        // æ›´æ–°åº•éƒ¨
        document.getElementById('totalAttempted').innerText = stats.attempted;
        document.getElementById('totalFailed').innerText = stats.failed;
        document.getElementById('totalEarned').innerText = stats.earned;
        const avg = stats.gpaCredits > 0 ? (stats.weightedSum / stats.gpaCredits) : 0;
        document.getElementById('semesterAvg').innerText = avg.toFixed(2);
        
        localStorage.setItem('ocrGrades', JSON.stringify(courses));
    }

    function update(idx, key, val) {
        courses[idx][key] = val;
        render(); // é€™è£¡ç°¡å–®è™•ç†ï¼Œç›´æ¥é‡ç¹ª
    }

    function addCourse() {
        courses.push({ id: Date.now(), name: '', type: 'å¿…', credit: 3, components: [{score: '', weight: 100}] });
        render();
        window.scrollTo(0, document.body.scrollHeight);
    }

    function del(idx) {
        if(confirm('åˆªé™¤?')) { courses.splice(idx, 1); render(); }
    }

    function resetData() {
        if(confirm('æ¸…ç©º?')) { courses = []; render(); }
    }

    // å•Ÿå‹•
    render();
</script>

</body>
</html>
