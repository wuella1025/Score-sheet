<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸æœŸæˆç¸¾è¨ˆç®— (PDF/åœ–ç‰‡å…¨èƒ½ç‰ˆ)</title>
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        :root {
            --bg-body: #2d3e46;
            --bg-card: #3b4c54;
            --text-main: #e0e6ed;
            --text-muted: #aab2bd;
            --accent-cyan: #4ecdc4;
            --accent-gold: #ffd700;
            --accent-red: #ff6b6b;
            --border: #4a5d66;
            --input-bg: #455a64;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 150px;
        }

        .container { max-width: 800px; margin: 0 auto; }
        h2 { text-align: center; color: var(--text-main); margin-bottom: 15px; }

        /* æ§åˆ¶å€ */
        .controls {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px dashed var(--border);
        }

        .btn-ocr {
            background: linear-gradient(135deg, #4ecdc4, #26a69a);
            color: #2d3e46;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
            display: inline-flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .btn-ocr:active { transform: scale(0.95); }

        .file-hint { font-size: 0.8rem; color: #aaa; margin-top: 8px; }

        /* ç‹€æ…‹é¡¯ç¤º */
        .ocr-status { margin-top: 15px; font-size: 0.9rem; color: var(--accent-cyan); font-weight: bold; min-height: 20px; }
        .progress-bar { width: 100%; height: 6px; background: #222; margin-top: 10px; border-radius: 3px; overflow: hidden; display: none; }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-gold); transition: width 0.3s; }
        
        #debugText {
            display: none; width: 100%; height: 120px; background: #111; color: #0f0;
            font-family: monospace; font-size: 0.8rem; margin-top: 15px; padding: 10px;
            border: 1px solid #444; overflow-y: scroll; border-radius: 6px;
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-header {
            display: grid;
            grid-template-columns: 30px 1fr 50px 50px 60px 30px;
            padding: 10px;
            font-weight: bold;
            color: var(--accent-gold);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
            text-align: center;
        }
        .list-header div:nth-child(2) { text-align: left; }

        .course-item {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            margin-bottom: 2px;
            border-radius: 4px;
            animation: fadeIn 0.3s;
        }
        .course-summary {
            display: grid;
            grid-template-columns: 30px 1fr 50px 50px 60px 30px;
            padding: 12px 10px;
            align-items: center;
        }

        input, select {
            background: transparent; border: 1px solid transparent; color: var(--text-main);
            font-size: 1rem; width: 100%; padding: 5px; border-radius: 4px; outline: none; text-align: center;
        }
        .input-name { text-align: left; font-weight: bold; }
        input:focus { background: var(--input-bg); border-bottom: 2px solid var(--accent-cyan); }
        .score-display { font-weight: bold; font-size: 1.1rem; text-align: center; }

        /* RWD */
        @media (max-width: 600px) {
            .list-header { display: none; }
            .course-summary {
                grid-template-columns: 25px 1fr auto;
                grid-template-areas: "idx name score" "idx info score";
                gap: 5px;
            }
            .input-name { grid-area: name; font-size: 1.1rem; }
            .mobile-info { grid-area: info; display: flex; gap: 10px; font-size: 0.85rem; color: var(--text-muted); }
            .score-display { grid-area: score; text-align: right; min-width: 40px; }
            .desktop-only { display: none; }
        }

        .footer-stats {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #263238;
            border-top: 3px solid var(--accent-cyan);
            display: grid; grid-template-columns: repeat(4, 1fr);
            padding: 15px 5px; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .stat-box { text-align: center; border-right: 1px solid var(--border); }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: white; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>å­¸æœŸæˆç¸¾è¨ˆç®— (å…¨èƒ½ç‰ˆ)</h2>

    <div class="controls">
        <button class="btn-ocr" onclick="document.getElementById('fileInput').click()">
            ğŸ“‚ ä¸Šå‚³ PDF æˆ– åœ–ç‰‡
        </button>
        <input type="file" id="fileInput" accept="image/*, application/pdf" style="display:none" onchange="handleFile(this)">
        
        <div class="file-hint">æ”¯æ´ï¼š.pdf, .jpg, .png (è‡ªå‹•è™•ç†é»‘åº•)</div>

        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="ocr-status" id="ocrStatus">è«‹ä¸Šå‚³æ‚¨çš„æˆç¸¾å–®</div>
        
        <textarea id="debugText" readonly placeholder="é€™è£¡æœƒé¡¯ç¤º AI è®€å–åˆ°çš„åŸå§‹æ–‡å­—..."></textarea>
    </div>

    <div class="list-header">
        <div>#</div><div>èª²ç¨‹åç¨±</div><div>ä¿®åˆ¥</div><div>å­¸åˆ†</div><div>ç¸½åˆ†</div><div></div>
    </div>
    <div id="courseList"></div>
    <div id="emptyMsg" style="text-align:center; padding:30px; color:#888;">ç›®å‰ç„¡è³‡æ–™</div>
    
    <div style="text-align: center; margin-top: 20px;">
         <button onclick="if(confirm('æ¸…ç©º?')){courses=[]; render();}" style="background:none; border:none; color:#666; text-decoration:underline;">é‡ç½®</button>
    </div>
</div>

<div class="footer-stats">
    <div class="stat-box"><div class="stat-label">ç¸½å­¸åˆ†</div><div class="stat-val" id="totalCredits">0</div></div>
    <div class="stat-box"><div class="stat-label">å¯¦å¾—</div><div class="stat-val" id="earnedCredits">0</div></div>
    <div class="stat-box"><div class="stat-label">ä¸åŠæ ¼</div><div class="stat-val" id="failedCredits" style="color:#ff6b6b">0</div></div>
    <div class="stat-box"><div class="stat-label">å¹³å‡</div><div class="stat-val" id="semesterAvg" style="color:#ffd700">0.0</div></div>
</div>

<script>
    // è¨­å®š PDF.js çš„ Worker (é€™æ˜¯è§£æ PDF å¿…é ˆçš„)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let courses = [];

    // --- æª”æ¡ˆè™•ç†å…¥å£ ---
    async function handleFile(input) {
        if (!input.files[0]) return;
        const file = input.files[0];
        
        const status = document.getElementById('ocrStatus');
        const bar = document.getElementById('progressBar');
        const fill = document.getElementById('progressFill');
        const debugArea = document.getElementById('debugText');
        
        bar.style.display = 'block';
        fill.style.width = '10%';
        debugArea.style.display = 'none';
        debugArea.value = '';
        status.innerText = "æ­£åœ¨åˆ†ææª”æ¡ˆ...";

        try {
            let imagesToProcess = [];

            // 1. åˆ¤æ–·æª”æ¡ˆé¡å‹
            if (file.type === 'application/pdf') {
                status.innerText = "åµæ¸¬åˆ° PDFï¼Œæ­£åœ¨è½‰æ›ç‚ºåœ–ç‰‡...";
                imagesToProcess = await convertPdfToImages(file);
            } else {
                status.innerText = "åµæ¸¬åˆ°åœ–ç‰‡ï¼Œæ­£åœ¨é è™•ç†...";
                // åœ–ç‰‡ç›´æ¥è®€å–ä¸¦é è™•ç† (åè‰²)
                const imgDataUrl = await preprocessImage(file);
                imagesToProcess = [imgDataUrl];
            }

            // 2. é–‹å§‹ OCR è¾¨è­˜ (æ”¯æ´å¤šé )
            status.innerText = "å•Ÿå‹• AI è­˜åˆ¥å¼•æ“...";
            const worker = Tesseract.createWorker({
                logger: m => {
                    if(m.status === 'recognizing text') {
                        fill.style.width = `${m.progress * 100}%`;
                        status.innerText = `è®€å–æ–‡å­—ä¸­... ${Math.round(m.progress * 100)}%`;
                    }
                }
            });

            await worker.load();
            await worker.loadLanguage('chi_tra');
            await worker.initialize('chi_tra');

            let fullText = "";
            
            // é€é è¾¨è­˜
            for (let i = 0; i < imagesToProcess.length; i++) {
                if(imagesToProcess.length > 1) status.innerText = `æ­£åœ¨è®€å–ç¬¬ ${i+1} é ...`;
                const { data: { text } } = await worker.recognize(imagesToProcess[i]);
                fullText += text + "\n";
            }
            
            await worker.terminate();

            // 3. é¡¯ç¤ºçµæœèˆ‡è§£æ
            console.log("Full OCR Text:", fullText);
            debugArea.value = fullText;
            debugArea.style.display = 'block';

            const newCourses = parseLooseText(fullText);

            if (newCourses.length > 0) {
                courses = [...courses, ...newCourses];
                render();
                status.innerText = `æˆåŠŸåŒ¯å…¥ï¼å…± ${newCourses.length} é–€èª²ç¨‹ã€‚`;
            } else {
                status.innerText = "âŒ æœªæ‰¾åˆ°èª²ç¨‹è³‡æ–™ï¼Œè«‹æª¢æŸ¥ä¸‹æ–¹åŸå§‹æ–‡å­—æ˜¯å¦ç‚ºäº‚ç¢¼ã€‚";
            }

        } catch (e) {
            status.innerText = "ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message;
            console.error(e);
        } finally {
            setTimeout(() => bar.style.display = 'none', 3000);
            input.value = ''; 
        }
    }

    // --- PDF è½‰åœ–ç‰‡æ ¸å¿ƒé‚è¼¯ ---
    async function convertPdfToImages(file) {
        const fileData = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(fileData).promise;
        const images = [];

        // è®€å–æ¯ä¸€é 
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 }); // æ”¾å¤§ 2 å€ä»¥æé«˜æ¸…æ™°åº¦
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            
            // å°‡ Canvas è½‰ç‚ºåœ–ç‰‡ä¸¦é€²è¡Œåè‰²æª¢æŸ¥
            // é€™è£¡æˆ‘å€‘æŠŠ canvas è½‰æˆ Blob å‚³çµ¦é è™•ç†å‡½æ•¸
            const blob = await new Promise(r => canvas.toBlob(r));
            const processedImg = await preprocessImage(blob);
            images.push(processedImg);
        }
        return images;
    }

    // --- åœ–åƒå¢å¼· (åè‰²) ---
    function preprocessImage(fileOrBlob) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ·±è‰²èƒŒæ™¯ (å–æ¨£)
                let totalBrightness = 0;
                let samples = 0;
                for(let i=0; i<data.length; i+=100) { 
                    totalBrightness += (data[i] + data[i+1] + data[i+2]) / 3;
                    samples++;
                }
                const avg = totalBrightness / samples;

                if (avg < 128) {
                    // åŸ·è¡Œåè‰²
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                    ctx.putImageData(imageData, 0, 0);
                }
                resolve(canvas.toDataURL('image/png'));
            };
            img.src = URL.createObjectURL(fileOrBlob);
        });
    }

    // --- è§£æé‚è¼¯ (å¯¬é¬†æ¨¡å¼) ---
    function parseLooseText(text) {
        const lines = text.split('\n');
        const result = [];
        lines.forEach(line => {
            let clean = line.trim().replace(/\s+/g, ' ');
            // é‚è¼¯ï¼šæ‰¾ä¸€è¡Œè£¡é¢æœ‰ã€Œå¿…/é¸ã€ä¸”æœ‰ã€Œæ•¸å­—ã€
            if (clean.includes('å¿…') || clean.includes('é¸')) {
                // æ‰¾å­¸åˆ† (0-9)
                let creditMatch = clean.match(/(å¿…|é¸).*?(\d)/) || clean.match(/(\d).*?(å¿…|é¸)/);
                if (creditMatch) {
                    // å˜—è©¦æå–åç¨± (æœ€é•·çš„é‚£æ®µæ–‡å­—)
                    let parts = clean.split(' ');
                    let name = parts.reduce((a, b) => a.length > b.length ? a : b, '');
                    name = name.replace(/[^\u4e00-\u9fa5a-zA-Z\(\)\-]/g, ''); // æ¸…ç†é›œè¨Š
                    
                    let type = clean.includes('å¿…') ? 'å¿…' : 'é¸';
                    let credit = parseInt(clean.match(/\d/)[0]);
                    
                    if (credit >= 0 && credit <= 10 && name.length > 1) {
                        result.push({
                            id: Date.now() + Math.random(),
                            name: name, type: type, credit: credit,
                            components: [{ name: 'æœŸæœ«', score: '', weight: 100 }]
                        });
                    }
                }
            }
        });
        return result;
    }

    // --- UI æ¸²æŸ“èˆ‡è¨ˆç®— ---
    function render() {
        const list = document.getElementById('courseList');
        const emptyMsg = document.getElementById('emptyMsg');
        
        if(courses.length === 0) {
            list.innerHTML = '';
            emptyMsg.style.display = 'block';
            updateFooter(0,0,0,0);
            return;
        }
        emptyMsg.style.display = 'none';
        list.innerHTML = '';

        let tCr=0, eCr=0, fCr=0, wS=0, vCr=0;

        courses.forEach((c, idx) => {
            let s=0, w=0;
            c.components.forEach(cmp => {
                s += (parseFloat(cmp.score)||0)*(parseFloat(cmp.weight||0)/100);
                w += parseFloat(cmp.weight)||0;
            });
            const final = Math.round(s);
            const cr = parseFloat(c.credit)||0;

            tCr += cr;
            if(final>=60) eCr += cr;
            else if(cr>0) fCr += cr;
            if(cr>0) { wS += final*cr; vCr += cr; }

            const div = document.createElement('div');
            div.className = 'course-item';
            div.innerHTML = `
                <div class="course-summary">
                    <div style="text-align:center; color:#888;">${idx+1}</div>
                    <div>
                        <input type="text" class="input-name" value="${c.name}" onchange="u(${idx},'name',this.value)">
                        <div class="mobile-info" style="display:${window.innerWidth<=600?'flex':'none'}">
                            <span>${c.type}</span> <span>${c.credit}å­¸åˆ†</span>
                        </div>
                    </div>
                    <div class="desktop-only">
                        <select onchange="u(${idx},'type',this.value)">
                            <option value="å¿…" ${c.type==='å¿…'?'selected':''}>å¿…</option>
                            <option value="é¸" ${c.type==='é¸'?'selected':''}>é¸</option>
                        </select>
                    </div>
                    <div class="desktop-only">
                        <input type="number" value="${c.credit}" onchange="u(${idx},'credit',this.value)">
                    </div>
                    <div class="score-display" style="color:${final<60?'#ff6b6b':'#fff'}">
                        ${w>0?final:'-'}
                    </div>
                    <button onclick="d(${idx})" style="background:none; border:none; color:#666; cursor:pointer;">Ã—</button>
                </div>
            `;
            list.appendChild(div);
        });
        const avg = vCr>0 ? (wS/vCr) : 0;
        updateFooter(tCr, eCr, fCr, avg);
    }

    function updateFooter(t,e,f,a) {
        document.getElementById('totalCredits').innerText = t;
        document.getElementById('earnedCredits').innerText = e;
        document.getElementById('failedCredits').innerText = f;
        document.getElementById('semesterAvg').innerText = a.toFixed(2);
    }
    function u(i,k,v){ courses[i][k]=v; render(); }
    function d(i){ if(confirm('åˆªé™¤?')) { courses.splice(i,1); render(); } }

    render();
</script>

</body>
</html>
